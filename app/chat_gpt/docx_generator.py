import asyncio
from openai import AsyncOpenAI
from docx import Document
from docx.shared import Inches
from datetime import datetime
import os
from app.config import settings


class KPService:
    def __init__(self):
        self.client = AsyncOpenAI(api_key=settings.CHAT_GPT_API_KEY)

    async def generate_kp_content(self, project_description: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ö–ü —á–µ—Ä–µ–∑ ChatGPT"""

        prompt = f"""
        –ù–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ–∑–¥–∞–π –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ö–ü) –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞. 
        –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ –Ω–∏–∂–µ, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä—É–π –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç.

        –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê:
        {project_description}

        –°–¢–†–£–ö–¢–£–†–ê –ö–û–ú–ú–ï–†–ß–ï–°–ö–û–ì–û –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø:

        # **–ü—Ä–æ–µ–∫—Ç: [–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞]**

        ## **–ü–ª–∞–Ω —Ä–∞–±–æ—Ç—ã**

        ### **–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:**
        [–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Å—É—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞]

        ### **–≠—Ç–∞–ø 1: Frontend (React/vite)**
        | **–ó–∞–¥–∞—á–∞** | **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è** |
        |------------|-----------------|
        | [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 1] | [–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞] |
        | [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 2] | [–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞] |

        ### **–≠—Ç–∞–ø 2: Backend (FastAPI)**
        | **–ó–∞–¥–∞—á–∞** | **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è** |
        |------------|-----------------|
        | [–ú–æ–¥—É–ª—å 1] | [–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞] |
        | [–ú–æ–¥—É–ª—å 2] | [–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞] |

        ### **–≠—Ç–∞–ø 3: –î–∏–∑–∞–π–Ω**
        | **–ó–∞–¥–∞—á–∞** | **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è** |
        |------------|-----------------|
        | [–≠–ª–µ–º–µ–Ω—Ç –¥–∏–∑–∞–π–Ω–∞ 1] | [–û–ø–∏—Å–∞–Ω–∏–µ] |
        | [–≠–ª–µ–º–µ–Ω—Ç –¥–∏–∑–∞–π–Ω–∞ 2] | [–û–ø–∏—Å–∞–Ω–∏–µ] |

        ### **–≠—Ç–∞–ø 4: –î–µ–ø–ª–æ–π –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
        | **–ó–∞–¥–∞—á–∞** | **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è** |
        |------------|-----------------|
        | [–ó–∞–¥–∞—á–∞ –¥–µ–ø–ª–æ—è] | [–û–ø–∏—Å–∞–Ω–∏–µ] |

        ### **–¶–µ–Ω–∞/–°—Ä–æ–∫–∏/–≠—Ç–∞–ø—ã**
        | **–≠—Ç–∞–ø—ã** | **–°—Ä–æ–∫–∏** | **–¶–µ–Ω–∞** |
        |-----------|-----------|----------|
        | [–≠—Ç–∞–ø 1] | [–≤—Ä–µ–º—è] | [—Å—Ç–æ–∏–º–æ—Å—Ç—å] |
        | [–≠—Ç–∞–ø 2] | [–≤—Ä–µ–º—è] | [—Å—Ç–æ–∏–º–æ—Å—Ç—å] |
        | **–ò—Ç–æ–≥:** | **[–æ–±—â–µ–µ –≤—Ä–µ–º—è]** | **[–æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å]** |

        –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
        1. –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º
        2. –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏ –ø–æ–ª–µ–∑–Ω–æ–π –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        3. –°—Ä–æ–∫–∏ –∏ —Ü–µ–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–ª—è –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
        4. –°–æ—Ö—Ä–∞–Ω—è–π —Ç–∞–±–ª–∏—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ
        5. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞
        """

        response = await self.client.responses.create(
            model=settings.CHAT_GPT_MODEL,
            input=[{"role": "user", "content": prompt}]
        )

        return response.output_text

    def create_kp_document(self, kp_content: str, project_name: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç .docx —Ñ–∞–π–ª —Å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º"""

        # –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        doc = Document()

        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        title = doc.add_heading(f'–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: {project_name}', 0)

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É
        doc.add_paragraph(f'–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: {datetime.now().strftime("%d.%m.%Y")}')
        doc.add_paragraph()

        # –†–∞–∑–±–∏—Ä–∞–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ç GPT –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç
        lines = kp_content.split('\n')

        for line in lines:
            line = line.strip()
            if not line:
                continue

            if line.startswith('# '):
                # –ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                doc.add_heading(line[2:], level=1)
            elif line.startswith('## '):
                # –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
                doc.add_heading(line[3:], level=2)
            elif line.startswith('### '):
                # –ü–æ–¥–ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
                doc.add_heading(line[4:], level=3)
            elif '|' in line and line.count('|') >= 2:
                # –¢–∞–±–ª–∏—Ü–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å |, –±—É–¥–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
                continue
            else:
                # –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
                doc.add_paragraph(line)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        filename = f"–ö–ü_{project_name.replace(' ', '_')}_{datetime.now().strftime('%Y%m%d_%H%M')}.docx"
        filepath = os.path.join('generated_kp', filename)

        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –Ω–µ—Ç
        os.makedirs('generated_kp', exist_ok=True)

        doc.save(filepath)
        return filepath


# –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def test_kp_generation():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ö–ü"""

    # –ü—Ä–∏–º–µ—Ä –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
    project_description = """
    –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã. 
    –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: –≤—ã–±–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –º–µ–Ω—é, –∫–æ—Ä–∑–∏–Ω–∞, –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞.
    –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: React Native –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, Node.js –¥–ª—è –±—ç–∫–µ–Ω–¥–∞, MongoDB –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤, push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è.
    """

    kp_service = KPService()

    try:
        print("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ö–ü —á–µ—Ä–µ–∑ ChatGPT...")
        kp_content = await kp_service.generate_kp_content(project_description)

        print("üìÑ –°–æ–∑–¥–∞–µ–º .docx —Ñ–∞–π–ª...")
        project_name = "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã"
        filepath = kp_service.create_kp_document(kp_content, project_name)

        print(f"‚úÖ –ö–ü —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ: {filepath}")
        print("\nüìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ö–ü:")
        print(kp_content)

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
    asyncio.run(test_kp_generation())